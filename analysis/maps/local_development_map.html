<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2025 Zone 1 Election Results - Local Development Map</title>
    
    <!-- Leaflet instead of Mapbox for local development -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Custom styles -->
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
        }
        
        #map {
            width: 100vw;
            height: 100vh;
        }
        
        .map-overlay {
            position: absolute;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 8px;
            padding: 20px;
            font-size: 14px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            max-width: 350px;
            z-index: 1000;
        }
        
        .map-overlay-top {
            top: 20px;
            left: 20px;
        }
        
        .map-overlay-bottom {
            bottom: 20px;
            right: 20px;
            max-width: 300px;
        }
        
        .layer-control {
            margin-bottom: 15px;
        }
        
        .layer-control h3 {
            margin: 0 0 10px 0;
            color: #2c3e50;
            font-size: 16px;
            font-weight: 600;
        }
        
        .layer-control label {
            display: block;
            margin: 8px 0;
            cursor: pointer;
            color: #34495e;
            font-weight: 500;
        }
        
        .layer-control input[type="radio"] {
            margin-right: 8px;
        }
        
        .legend {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 6px;
            padding: 12px;
            margin-top: 10px;
        }
        
        .legend-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 4px 0;
            font-size: 12px;
        }
        
        .legend-color {
            width: 20px;
            height: 12px;
            margin-right: 8px;
            border-radius: 2px;
            border: 1px solid #ccc;
        }
        
        .info-panel {
            color: #34495e;
            line-height: 1.5;
        }
        
        .info-panel h2 {
            margin: 0 0 15px 0;
            color: #2c3e50;
            font-size: 18px;
        }
        
        .info-panel p {
            margin: 8px 0;
        }
        
        .highlight {
            background-color: #fff3cd;
            padding: 10px;
            border-radius: 6px;
            border-left: 4px solid #ffc107;
            margin: 10px 0;
        }
        
        .zone1-indicator {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: bold;
            color: white;
            margin-left: 5px;
        }
        
        .zone1-yes {
            background-color: #28a745;
        }
        
        .zone1-no {
            background-color: #6c757d;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        @media (max-width: 768px) {
            .map-overlay {
                max-width: 280px;
                padding: 15px;
            }
            
            .map-overlay-top {
                top: 10px;
                left: 10px;
            }
            
            .map-overlay-bottom {
                bottom: 10px;
                right: 10px;
                max-width: 250px;
            }
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <!-- Layer Controls -->
    <div class="map-overlay map-overlay-top">
        <div class="layer-control">
            <h3>üó∫Ô∏è Map Layers</h3>
            <label>
                <input type="radio" name="layer" value="participation" checked>
                Zone 1 Participation
            </label>
            <label>
                <input type="radio" name="layer" value="total_votes">
                Total Votes Cast
            </label>
            <label>
                <input type="radio" name="layer" value="turnout">
                Voter Turnout Rate
            </label>
            <label>
                <input type="radio" name="layer" value="splitt_pct">
                Splitt Vote Share
            </label>
            <label>
                <input type="radio" name="layer" value="political_lean">
                Political Lean
            </label>
            <label>
                <input type="radio" name="layer" value="dem_advantage">
                Democratic Advantage
            </label>
            <label>
                <input type="radio" name="layer" value="engagement">
                Civic Engagement
            </label>
            <label>
                <input type="radio" name="layer" value="competitiveness">
                Competitiveness
            </label>
        </div>
        
        <div id="legend" class="legend">
            <div class="loading">Loading legend...</div>
        </div>
    </div>
    
    <!-- Info Panel -->
    <div class="map-overlay map-overlay-bottom">
        <div class="info-panel">
            <h2>2025 Zone 1 Election</h2>
            <p><strong>Multnomah County School Board</strong></p>
            <p>Interactive map showing election results and voter registration patterns across Multnomah County precincts.</p>
            
            <div class="highlight">
                <strong>üéØ Click any precinct</strong> to see detailed election and registration data.
            </div>
            
            <p><small>
                <strong>Development Version:</strong><br>
                Uses local GeoJSON data. For production, use vector tiles with Mapbox.
            </small></p>
            
            <p><small>
                <strong>Data Sources:</strong><br>
                ‚Ä¢ Multnomah County Elections Division<br>
                ‚Ä¢ Oregon Secretary of State Voter Registration
            </small></p>
        </div>
    </div>

    <script>
        // Initialize the map
        const map = L.map('map').setView([45.52, -122.6], 10);
        
        // Add base layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors',
            maxZoom: 16,
            minZoom: 8
        }).addTo(map);
        
        // Global variables
        let electionData = null;
        let electionLayer = null;
        let currentProperty = 'participated_election';
        
        // Layer configurations
        const layerConfigs = {
            participation: {
                title: 'Zone 1 Participation',
                property: 'participated_election',
                type: 'categorical',
                colors: ['#dc3545', '#28a745'],
                labels: ['Did not participate', 'Participated'],
                description: 'Shows which precincts participated in the Zone 1 election'
            },
            total_votes: {
                title: 'Total Votes Cast',
                property: 'cnt_total_votes',
                type: 'numeric',
                colors: ['#fff5eb', '#fd8d3c', '#d94801', '#8c2d04'],
                stops: [0, 50, 150, 300],
                description: 'Number of votes cast in each precinct (Zone 1 only)'
            },
            turnout: {
                title: 'Voter Turnout Rate',
                property: 'turnout_rate',
                type: 'percentage',
                colors: ['#f0f9ff', '#7dd3fc', '#0284c7', '#1e40af'],
                stops: [0, 0.15, 0.25, 0.35],
                description: 'Percentage of registered voters who voted'
            },
            splitt_pct: {
                title: 'Splitt Vote Share',
                property: 'pct_splitt',
                type: 'percentage',
                colors: ['#f0fdf4', '#86efac', '#22c55e', '#15803d'],
                stops: [0.5, 0.7, 0.8, 0.9],
                description: 'Percentage of votes received by Splitt'
            },
            political_lean: {
                title: 'Political Lean',
                property: 'political_lean',
                type: 'categorical',
                colors: ['#dc2626', '#f87171', '#d1d5db', '#60a5fa', '#2563eb'],
                labels: ['Strong Rep', 'Lean Rep', 'Competitive', 'Lean Dem', 'Strong Dem'],
                description: 'Political lean based on voter registration patterns'
            },
            dem_advantage: {
                title: 'Democratic Advantage',
                property: 'dem_advantage',
                type: 'diverging',
                colors: ['#dc2626', '#f87171', '#f9fafb', '#60a5fa', '#2563eb'],
                stops: [-0.4, -0.2, 0, 0.2, 0.4],
                description: 'Democratic registration advantage (positive = more Dem)'
            },
            engagement: {
                title: 'Civic Engagement Score',
                property: 'engagement_score',
                type: 'numeric',
                colors: ['#fef3c7', '#fbbf24', '#f59e0b', '#d97706'],
                stops: [0, 0.2, 0.35, 0.5],
                description: 'Composite score of registration diversity and turnout'
            },
            competitiveness: {
                title: 'Competitiveness',
                property: 'competitiveness',
                type: 'categorical',
                colors: ['#22c55e', '#84cc16', '#eab308', '#f97316', '#dc2626'],
                labels: ['Safe', 'Likely', 'Lean', 'Toss-up', 'Competitive'],
                description: 'Election competitiveness classification'
            }
        };
        
        // Load the election data
        fetch('geospatial/2025_election_zone1_results.geojson')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                electionData = data;
                console.log(`Loaded ${data.features.length} features`);
                
                // Add the election layer
                electionLayer = L.geoJSON(electionData, {
                    style: function(feature) {
                        return getFeatureStyle(feature, currentProperty);
                    },
                    onEachFeature: function(feature, layer) {
                        layer.on('click', function(e) {
                            showPopup(feature, e.latlng);
                        });
                        
                        layer.on('mouseover', function(e) {
                            layer.setStyle({
                                weight: 3,
                                fillOpacity: 0.9
                            });
                        });
                        
                        layer.on('mouseout', function(e) {
                            electionLayer.resetStyle(e.target);
                        });
                    }
                }).addTo(map);
                
                // Fit map to data bounds
                map.fitBounds(electionLayer.getBounds());
                
                // Update legend
                updateLegend('participation');
                
                console.log('Election data loaded successfully');
            })
            .catch(error => {
                console.error('Error loading election data:', error);
                document.getElementById('legend').innerHTML = 
                    '<div style="color: red;">Error loading data. Please check the console.</div>';
            });
        
        // Layer switching
        document.querySelectorAll('input[name="layer"]').forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.checked && electionLayer) {
                    const layerName = this.value;
                    currentProperty = layerConfigs[layerName].property;
                    
                    // Update layer styling
                    electionLayer.eachLayer(function(layer) {
                        layer.setStyle(getFeatureStyle(layer.feature, currentProperty));
                    });
                    
                    updateLegend(layerName);
                }
            });
        });
        
        function getFeatureStyle(feature, property) {
            const value = feature.properties[property];
            const layerName = getCurrentLayerName(property);
            const config = layerConfigs[layerName];
            
            let color = '#cccccc'; // default
            let fillOpacity = 0.7;
            
            if (config.type === 'categorical') {
                if (layerName === 'participation') {
                    color = (value === true || value === 'true') ? config.colors[1] : config.colors[0];
                } else if (layerName === 'political_lean') {
                    const colorMap = {
                        'Strong Rep': config.colors[0],
                        'Lean Rep': config.colors[1],
                        'Competitive': config.colors[2],
                        'Lean Dem': config.colors[3],
                        'Strong Dem': config.colors[4]
                    };
                    color = colorMap[value] || '#cccccc';
                } else if (layerName === 'competitiveness') {
                    const colorMap = {
                        'Safe': config.colors[0],
                        'Likely': config.colors[1],
                        'Lean': config.colors[2],
                        'Toss-up': config.colors[3],
                        'Competitive': config.colors[4]
                    };
                    color = colorMap[value] || '#cccccc';
                }
            } else {
                // Numeric interpolation
                const numValue = parseFloat(value) || 0;
                color = interpolateColor(numValue, config.stops, config.colors);
            }
            
            return {
                fillColor: color,
                weight: 1,
                opacity: 0.8,
                color: '#333333',
                fillOpacity: fillOpacity
            };
        }
        
        function getCurrentLayerName(property) {
            for (const [layerName, config] of Object.entries(layerConfigs)) {
                if (config.property === property) {
                    return layerName;
                }
            }
            return 'participation';
        }
        
        function interpolateColor(value, stops, colors) {
            if (value <= stops[0]) return colors[0];
            if (value >= stops[stops.length - 1]) return colors[colors.length - 1];
            
            for (let i = 0; i < stops.length - 1; i++) {
                if (value >= stops[i] && value <= stops[i + 1]) {
                    // Simple interpolation - just return the appropriate color
                    const ratio = (value - stops[i]) / (stops[i + 1] - stops[i]);
                    return ratio > 0.5 ? colors[i + 1] : colors[i];
                }
            }
            
            return colors[0];
        }
        
        function updateLegend(layerName) {
            const config = layerConfigs[layerName];
            const legendDiv = document.getElementById('legend');
            
            let legendHTML = `<div class="legend-title">${config.title}</div>`;
            
            if (config.type === 'categorical') {
                config.colors.forEach((color, index) => {
                    if (config.labels && config.labels[index]) {
                        legendHTML += `
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: ${color}"></div>
                                ${config.labels[index]}
                            </div>
                        `;
                    }
                });
            } else {
                // Numeric legend
                config.colors.forEach((color, index) => {
                    if (config.stops && config.stops[index] !== undefined) {
                        let value = config.stops[index];
                        if (config.type === 'percentage') {
                            value = (value * 100).toFixed(0) + '%';
                        } else {
                            value = value.toLocaleString();
                        }
                        legendHTML += `
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: ${color}"></div>
                                ${value}${index === config.colors.length - 1 ? '+' : ''}
                            </div>
                        `;
                    }
                });
            }
            
            legendHTML += `<div style="font-size: 11px; color: #666; margin-top: 8px;">${config.description}</div>`;
            legendDiv.innerHTML = legendHTML;
        }
        
        function showPopup(feature, latlng) {
            const props = feature.properties;
            
            // Build popup content
            let popupContent = `
                <div style="font-size: 13px; max-width: 300px;">
                    <div style="font-weight: bold; color: #2c3e50; margin-bottom: 8px; font-size: 15px;">
                        Precinct ${props.precinct || props.Precinct}
                        <span class="zone1-indicator ${props.participated_election ? 'zone1-yes' : 'zone1-no'}">
                            ${props.participated_election ? 'Zone 1' : 'No Zone 1'}
                        </span>
                    </div>
            `;
            
            // Election Results (if participated)
            if (props.participated_election && props.cnt_total_votes > 0) {
                popupContent += `
                    <div style="margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px solid #ecf0f1;">
                        <strong>üó≥Ô∏è Election Results</strong><br>
                        <small>Total Votes: <strong>${parseInt(props.cnt_total_votes || 0).toLocaleString()}</strong></small><br>
                        <small>Splitt: <strong>${parseInt(props.cnt_splitt || 0).toLocaleString()} (${(parseFloat(props.pct_splitt || 0) * 100).toFixed(1)}%)</strong></small><br>
                        <small>Cavagnolo: <strong>${parseInt(props.cnt_cavagnolo || 0).toLocaleString()} (${(parseFloat(props.pct_cavagnolo || 0) * 100).toFixed(1)}%)</strong></small><br>
                        <small>Turnout: <strong>${(parseFloat(props.turnout_rate || 0) * 100).toFixed(1)}%</strong></small>
                    </div>
                `;
            }
            
            // Voter Registration
            if (props.TOTAL > 0) {
                popupContent += `
                    <div style="margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px solid #ecf0f1;">
                        <strong>üë• Voter Registration</strong><br>
                        <small>Total: <strong>${parseInt(props.TOTAL || 0).toLocaleString()}</strong></small><br>
                        <small>Democratic: <strong>${parseInt(props.DEM || 0).toLocaleString()} (${(parseFloat(props.pct_dem || 0) * 100).toFixed(1)}%)</strong></small><br>
                        <small>Republican: <strong>${parseInt(props.REP || 0).toLocaleString()} (${(parseFloat(props.pct_rep || 0) * 100).toFixed(1)}%)</strong></small><br>
                        <small>Non-affiliated: <strong>${parseInt(props.NAV || 0).toLocaleString()} (${(parseFloat(props.pct_nav || 0) * 100).toFixed(1)}%)</strong></small>
                    </div>
                `;
            }
            
            // Political Analysis
            popupContent += `
                <div style="margin-bottom: 10px;">
                    <strong>üìä Political Analysis</strong><br>
                    <small>Political Lean: <strong>${props.political_lean || 'Unknown'}</strong></small><br>
                    <small>Dem Advantage: <strong>${(parseFloat(props.dem_advantage || 0) * 100).toFixed(1)}%</strong></small>
            `;
            
            if (props.participated_election) {
                popupContent += `<br><small>Engagement Score: <strong>${parseFloat(props.engagement_score || 0).toFixed(3)}</strong></small>`;
                popupContent += `<br><small>Competitiveness: <strong>${props.competitiveness || 'Unknown'}</strong></small>`;
            }
            
            popupContent += `
                    </div>
                </div>
            `;
            
            // Show popup
            L.popup()
                .setLatLng(latlng)
                .setContent(popupContent)
                .openOn(map);
        }
        
        // Add scale control
        L.control.scale().addTo(map);
    </script>
</body>
</html> 