<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Election Map Foundation Test</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: #f5f5f5;
        }
        
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .test-header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .test-content {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
            height: 600px;
        }
        
        .test-panel {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        #map {
            height: 100%;
            border-radius: 8px;
        }
        
        .test-button {
            background: #1976d2;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        
        .test-button:hover {
            background: #1565c0;
        }
        
        .test-output {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-success { background: #4caf50; }
        .status-error { background: #f44336; }
        .status-pending { background: #ff9800; }
        
        #loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <!-- Header -->
        <div class="test-header">
            <h1>üß™ Election Map Foundation Test</h1>
            <p>Testing the new modular JavaScript architecture components:</p>
            <div id="status-indicators"></div>
        </div>
        
        <!-- Main Content -->
        <div class="test-content">
            <!-- Test Panel -->
            <div class="test-panel">
                <h3>üîß Foundation Tests</h3>
                
                <h4>StateManager</h4>
                <button class="test-button" onclick="testStateManager()">Test State</button>
                <button class="test-button" onclick="testStateReactive()">Test Reactive</button>
                
                <h4>EventBus</h4>
                <button class="test-button" onclick="testEventBus()">Test Events</button>
                <button class="test-button" onclick="testEventHistory()">View History</button>
                
                <h4>MapManager</h4>
                <button class="test-button" onclick="testMapOperations()">Test Map Ops</button>
                <button class="test-button" onclick="testBasemaps()">Test Basemaps</button>
                
                <h4>Integration</h4>
                <button class="test-button" onclick="testFullIntegration()">Full Test</button>
                <button class="test-button" onclick="showDebugInfo()">Debug Info</button>
                
                <div id="test-output" class="test-output"></div>
            </div>
            
            <!-- Map Container -->
            <div class="test-panel">
                <div id="map"></div>
            </div>
        </div>
    </div>
    
    <!-- Loading Indicator -->
    <div id="loading" style="display: none;">
        <h3>Loading Election Map...</h3>
        <p>Initializing foundation components...</p>
    </div>
    
    <!-- Error Display -->
    <div id="error-display" style="display: none;"></div>

    <!-- External Dependencies -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Our New Modular JavaScript -->
    <script type="module">
        import { ElectionMapApp } from './js/app.js';
        
        // Global test functions
        window.testApp = null;
        
        // Initialize application
        async function initTestApp() {
            try {
                const app = new ElectionMapApp();
                await app.init();
                window.testApp = app;
                
                updateStatusIndicators();
                log('‚úÖ Application initialized successfully!');
                
            } catch (error) {
                console.error('Failed to initialize test app:', error);
                log(`‚ùå Initialization failed: ${error.message}`);
            }
        }
        
        // Utility functions
        function log(message) {
            const output = document.getElementById('test-output');
            const timestamp = new Date().toLocaleTimeString();
            output.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            output.scrollTop = output.scrollHeight;
        }
        
        function updateStatusIndicators() {
            const container = document.getElementById('status-indicators');
            const app = window.testApp;
            
            if (!app) {
                container.innerHTML = '<span class="status-indicator status-error"></span> Application not initialized';
                return;
            }
            
            const status = app.getStatus();
            container.innerHTML = `
                <div>
                    <span class="status-indicator ${status.initialized ? 'status-success' : 'status-error'}"></span>
                    App Initialized: ${status.initialized}
                </div>
                <div>
                    <span class="status-indicator ${status.state.mapInitialized ? 'status-success' : 'status-pending'}"></span>
                    Map Ready: ${status.state.mapInitialized}
                </div>
                <div>
                    <span class="status-indicator status-success"></span>
                    Components: ${status.components.length}
                </div>
                <div>
                    <span class="status-indicator status-success"></span>
                    Events: ${status.events.totalEvents}
                </div>
            `;
        }
        
        // Test Functions (make them global for buttons)
        window.testStateManager = function() {
            const app = window.testApp;
            if (!app) return log('‚ùå App not initialized');
            
            log('üîÑ Testing StateManager...');
            
            // Test state setting and getting
            app.state.setState({ testValue: 'Hello World' }, { source: 'test' });
            const value = app.state.getState('testValue');
            log(`‚úÖ State set/get: ${value}`);
            
            // Test nested state
            app.state.setState({ 
                nested: { 
                    level1: { 
                        level2: 'deep value' 
                    } 
                } 
            }, { source: 'test' });
            
            const deepValue = app.state.getNestedState('nested.level1.level2');
            log(`‚úÖ Nested state: ${deepValue}`);
            
            // Show debug state
            const debug = app.state.getDebugState();
            log(`‚úÖ StateManager has ${debug.stateKeys.length} keys, ${debug.subscriberCount} subscribers`);
        };
        
        window.testStateReactive = function() {
            const app = window.testApp;
            if (!app) return log('‚ùå App not initialized');
            
            log('üîÑ Testing reactive state updates...');
            
            // Subscribe to state changes
            const unsubscribe = app.state.subscribe(['reactiveTest'], (updates, state, source) => {
                log(`üì° Reactive update from ${source}: ${JSON.stringify(updates)}`);
            });
            
            // Trigger state change
            app.state.setState({ reactiveTest: Math.random() }, { source: 'reactive_test' });
            
            // Unsubscribe
            setTimeout(() => {
                unsubscribe();
                log('‚úÖ Reactive test completed, unsubscribed');
            }, 1000);
        };
        
        window.testEventBus = function() {
            const app = window.testApp;
            if (!app) return log('‚ùå App not initialized');
            
            log('üîÑ Testing EventBus...');
            
            // Set up event listener
            const unsubscribe = app.events.on('test-event', (data) => {
                log(`üì° Event received: ${data.message}`);
            });
            
            // Emit test event
            app.events.emit('test-event', { message: 'Hello from EventBus!' });
            
            // Test once listener
            app.events.once('one-time-event', (data) => {
                log(`üì° One-time event: ${data.message}`);
            });
            
            app.events.emit('one-time-event', { message: 'This will only fire once' });
            app.events.emit('one-time-event', { message: 'This will not fire' });
            
            const debug = app.events.getDebugInfo();
            log(`‚úÖ EventBus has ${debug.totalEvents} event types, ${debug.totalListeners} listeners`);
            
            unsubscribe();
        };
        
        window.testEventHistory = function() {
            const app = window.testApp;
            if (!app) return log('‚ùå App not initialized');
            
            const history = app.events.getHistory(5);
            log('üìä Recent Event History:');
            history.forEach((event, i) => {
                const time = new Date(event.timestamp).toLocaleTimeString();
                log(`  ${i + 1}. [${time}] ${event.eventName}`);
            });
        };
        
        window.testMapOperations = function() {
            const app = window.testApp;
            if (!app) return log('‚ùå App not initialized');
            
            log('üîÑ Testing Map operations...');
            
            const map = app.state.getState('map');
            if (!map) return log('‚ùå Map not available');
            
            // Test map methods
            const center = map.getCenter();
            const zoom = map.getZoom();
            log(`‚úÖ Map center: ${center.lat.toFixed(4)}, ${center.lng.toFixed(4)}`);
            log(`‚úÖ Map zoom: ${zoom}`);
            
            // Test map manager methods
            const metrics = app.mapManager.getPerformanceMetrics();
            log(`‚úÖ Map init time: ${metrics.initTime?.toFixed(2)}ms`);
            log(`‚úÖ Total layers: ${metrics.totalLayers}`);
        };
        
        window.testBasemaps = function() {
            const app = window.testApp;
            if (!app) return log('‚ùå App not initialized');
            
            log('üîÑ Testing basemap switching...');
            
            const basemaps = ['streets', 'satellite', 'topo', 'dark'];
            let index = 0;
            
            const switchBasemap = () => {
                const basemap = basemaps[index % basemaps.length];
                app.mapManager.setBasemap(basemap);
                log(`üó∫Ô∏è Switched to: ${basemap}`);
                index++;
                
                if (index < basemaps.length) {
                    setTimeout(switchBasemap, 2000);
                } else {
                    log('‚úÖ Basemap test completed');
                }
            };
            
            switchBasemap();
        };
        
        window.testFullIntegration = function() {
            const app = window.testApp;
            if (!app) return log('‚ùå App not initialized');
            
            log('üîÑ Running full integration test...');
            
            // Test state -> event -> map integration
            const testData = {
                timestamp: Date.now(),
                testId: Math.random().toString(36).substr(2, 9)
            };
            
            // Listen for state changes
            const unsubscribe = app.state.subscribe(['integrationTest'], (updates) => {
                app.events.emit('integration-event', updates);
            });
            
            // Listen for events
            const unsubscribeEvent = app.events.on('integration-event', (data) => {
                log(`üîó Integration flow: State -> Event -> ${data.integrationTest}`);
            });
            
            // Trigger the flow
            app.state.setState({ integrationTest: testData }, { source: 'integration_test' });
            
            setTimeout(() => {
                unsubscribe();
                unsubscribeEvent();
                log('‚úÖ Integration test completed');
            }, 1000);
        };
        
        window.showDebugInfo = function() {
            const app = window.testApp;
            if (!app) return log('‚ùå App not initialized');
            
            const status = app.getStatus();
            log('üêõ Debug Information:');
            log(`  App initialized: ${status.initialized}`);
            log(`  Total init time: ${status.totalTime.toFixed(2)}ms`);
            log(`  State keys: ${status.state.stateKeys.length}`);
            log(`  Event types: ${status.events.totalEvents}`);
            log(`  Map status: ${status.map.mapState}`);
            log(`  History length: ${status.state.historyLength}`);
            
            // Make debug object available in console
            window.debugInfo = status;
            log('üêõ Full debug info available as window.debugInfo');
        };
        
        // Initialize when page loads
        initTestApp();
    </script>
</body>
</html> 