<!DOCTYPE html>
<html>
<head>
    <title>Vector Tile Debug</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 20px; font-family: Arial, sans-serif; }
        #map { height: 500px; width: 100%; margin-bottom: 20px; }
        .debug-info { background: #f0f0f0; padding: 15px; border-radius: 5px; }
        .debug-result { margin: 10px 0; padding: 10px; border-radius: 3px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; border: 1px solid #b8daff; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>Vector Tile Debug</h1>
    
    <div id="map"></div>
    
    <div class="debug-info">
        <h3>Debug Results:</h3>
        <div id="results">Loading...</div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.vectorgrid@1.3.0/dist/Leaflet.VectorGrid.bundled.js"></script>

    <script>
        function addResult(message, type) {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `debug-result ${type}`;
            div.innerHTML = message;
            results.appendChild(div);
        }

        // Test vector tile loading
        function testVectorTiles() {
            addResult('🗺️ Creating map...', 'info');
            
            const map = L.map('map').setView([45.515, -122.68], 11);
            
            // Add base map
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            const tileUrl = 'http://localhost:8080/data/2025_election_zone1_total_votes_tiles/{z}/{x}/{y}.pbf';
            addResult(`🔄 Testing vector tiles from: ${tileUrl}`, 'info');
            
            // Try to load vector tiles with all possible layer names
            const possibleLayers = [
                'election_results',
                '2025_election_zone1_total_votes_tiles',
                'default',
                'data'
            ];

            possibleLayers.forEach((layerName, index) => {
                setTimeout(() => {
                    addResult(`🔄 Trying layer name: "${layerName}"`, 'info');
                    
                    const vectorLayer = L.vectorGrid.protobuf(tileUrl, {
                        rendererFactory: L.canvas.tile,
                        vectorTileLayerStyles: {
                            [layerName]: {
                                color: 'red',
                                fillColor: `hsl(${index * 60}, 70%, 50%)`,
                                fillOpacity: 0.8,
                                weight: 2
                            }
                        },
                        interactive: true
                    });

                    vectorLayer.on('add', () => {
                        addResult(`✅ Layer "${layerName}" added to map`, 'success');
                    });

                    vectorLayer.on('loading', () => {
                        addResult(`🔄 Layer "${layerName}" loading tiles...`, 'info');
                    });

                    vectorLayer.on('load', () => {
                        addResult(`✅ Layer "${layerName}" loaded tiles successfully`, 'success');
                    });

                    vectorLayer.on('tileerror', (e) => {
                        addResult(`❌ Layer "${layerName}" tile error: ${e.error}`, 'error');
                    });

                    vectorLayer.on('click', (e) => {
                        const props = e.layer.properties;
                        addResult(`🎯 Clicked feature in layer "${layerName}"!<br><pre>${JSON.stringify(props, null, 2)}</pre>`, 'success');
                    });

                    vectorLayer.addTo(map);
                    
                }, index * 1000); // Stagger attempts
            });
        }

        // Test tile server connectivity
        function testTileServer() {
            addResult('🔍 Testing tile server connectivity...', 'info');
            
            fetch('http://localhost:8080/')
                .then(response => {
                    if (response.ok) {
                        addResult('✅ Tile server is accessible', 'success');
                        return response.text();
                    } else {
                        addResult(`❌ Tile server error: ${response.status}`, 'error');
                    }
                })
                .then(html => {
                    if (html && html.includes('TileServer')) {
                        addResult('✅ TileServer GL detected', 'success');
                        testMetadata();
                    }
                })
                .catch(error => {
                    addResult(`❌ Cannot connect to tile server: ${error.message}`, 'error');
                });
        }

        // Test metadata endpoints
        function testMetadata() {
            addResult('🔍 Testing metadata endpoints...', 'info');
            
            const metadataUrl = 'http://localhost:8080/data/2025_election_zone1_total_votes_tiles.json';
            
            fetch(metadataUrl)
                .then(response => response.json())
                .then(metadata => {
                    addResult('✅ TileJSON metadata retrieved', 'success');
                    addResult(`📊 Vector layers: ${metadata.vector_layers?.map(l => l.id).join(', ') || 'Not specified'}`, 'info');
                    addResult(`📊 Zoom range: ${metadata.minzoom} - ${metadata.maxzoom}`, 'info');
                    addResult(`📊 Format: ${metadata.format}`, 'info');
                    
                    if (metadata.vector_layers && metadata.vector_layers.length > 0) {
                        const layer = metadata.vector_layers[0];
                        addResult(`📊 Layer "${layer.id}" fields: ${Object.keys(layer.fields || {}).join(', ')}`, 'info');
                        
                        // Try the actual layer name from metadata
                        setTimeout(() => {
                            testActualLayer(layer.id);
                        }, 2000);
                    }
                })
                .catch(error => {
                    addResult(`❌ Metadata error: ${error.message}`, 'error');
                });
        }

        // Test with the actual layer name from metadata
        function testActualLayer(layerName) {
            addResult(`🎯 Testing with actual layer name: "${layerName}"`, 'info');
            
            const map = L.map('map');
            const tileUrl = 'http://localhost:8080/data/2025_election_zone1_total_votes_tiles/{z}/{x}/{y}.pbf';
            
            const vectorLayer = L.vectorGrid.protobuf(tileUrl, {
                rendererFactory: L.canvas.tile,
                vectorTileLayerStyles: {
                    [layerName]: {
                        color: '#000',
                        fillColor: '#0066cc',
                        fillOpacity: 0.8,
                        weight: 1
                    }
                },
                interactive: true
            });

            vectorLayer.on('click', (e) => {
                const props = e.layer.properties;
                addResult(`🎯 SUCCESS! Clicked feature with actual layer name:<br><pre>${JSON.stringify(props, null, 2)}</pre>`, 'success');
            });

            vectorLayer.addTo(map);
        }

        // Start tests
        document.addEventListener('DOMContentLoaded', () => {
            testTileServer();
            setTimeout(testVectorTiles, 1000);
        });
    </script>
</body>
</html> 