<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- SEO & Social Meta -->
    <title>2025 Portland School Board Election Map - Interactive Voting Analysis</title>
    <meta name="description" content="Interactive map showing 2025 Portland Public Schools Board election results by precinct with voter turnout, candidate performance, and demographic analysis.">
    <meta name="keywords" content="Portland school board election, voting map, precinct results, 2025 election, PPS">
    <meta name="author" content="Ken Cavagnolo">

    <!-- Open Graph -->
    <meta property="og:title" content="2025 Portland School Board Election Map">
    <meta property="og:description" content="Interactive map showing election results by precinct with detailed voting analysis">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://statecraftai.github.io/maps/election_map.html">
    <meta property="og:image" content="https://statecraftai.github.io/maps/data/images/social/election-map-preview.png">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="2025 Portland School Board Election Map">
    <meta name="twitter:description" content="Interactive election results map with precinct-level analysis">

    <!-- Favicons -->
    <link rel="icon" type="image/x-icon" href="../data/images/favicons/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="../data/images/favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../data/images/favicons/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="../data/images/favicons/apple-touch-icon.png">

    <!-- Enhanced Favicon Suite -->
    <link rel="icon" type="image/png" sizes="192x192" href="../data/images/favicons/android-chrome-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="../data/images/favicons/android-chrome-512x512.png">
    <link rel="mask-icon" href="../data/images/favicons/safari-pinned-tab.svg" color="#3B82F6">
    <link rel="manifest" href="../data/images/favicons/site.webmanifest">
    <meta name="msapplication-TileColor" content="#3B82F6">
    <meta name="msapplication-TileImage" content="../data/images/favicons/mstile-150x150.png">
    <meta name="theme-color" content="#3B82F6">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />

    <!-- Leaflet plugins -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-fullscreen@1.0.1/dist/leaflet.fullscreen.css" />

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

    <!-- Main Application Stylesheet -->
    <link rel="stylesheet" href="css/election-map.css" />
</head>
<body>
    <!-- Map Watermark - Top Center Branding -->
    <div class="map-watermark" role="img" aria-label="StatecraftAI branding">
        <img src="../data/images/branding/logo.png"
             alt="StatecraftAI Logo"
             class="watermark-logo" />
        <span class="watermark-text">StatecraftAI</span>
    </div>

    <!-- Skip Link for Accessibility -->
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <!-- Loading State with ARIA -->
    <div id="loading" class="loading" role="status" aria-live="polite" aria-label="Loading election data">
        <h3>Loading Election Data...</h3>
        <p>Please wait while for the precinct and school data.</p>
        <span class="sr-only">Loading in progress...</span>
    </div>

    <!-- Error Display -->
    <div id="error-display" class="error-message" role="alert" aria-live="assertive" style="display: none;"></div>

    <!-- Main Application Container -->
    <main id="main-content">
        <!-- Interactive Map -->
        <section id="map" role="application" aria-label="Interactive election results map" tabindex="0">
            <!-- Map will be rendered here by Leaflet -->
        </section>

        <!-- Control Panel -->
        <aside class="control-panel panel" role="complementary" aria-labelledby="controls-heading">
            <header>
                <h3 id="controls-heading">Map Controls</h3>
            </header>

            <form role="form" aria-labelledby="controls-heading">
                <!-- Data & Display Section -->
                <section class="section" data-section="data-display">
                    <div class="section-header">
                        <h4>Data & Display</h4>
                        <span class="section-toggle">‚ñº</span>
                    </div>
                    <div class="section-content">
                <!-- Dataset Selection -->
                <div class="form-group">
                    <label for="dataset-select">Election Dataset:</label>
                    <select id="dataset-select" aria-describedby="dataset-help">
                        <!-- Options will be populated dynamically by JavaScript -->
                    </select>
                    <div id="dataset-help" class="sr-only">Choose which election dataset to display on the map</div>
                </div>

                <!-- Zone Filter -->
                <div class="zone-filter">
                            <label for="pps-only">
                                <input type="checkbox" id="pps-only" checked aria-describedby="zone-help">
                                Show PPS Districts Only
                    </label>
                    <div id="zone-help" class="sr-only">Filter to show only Zone 1 precincts on the map</div>
                </div>

                                        <!-- Layer Selection with Custom Expandable Groups -->
                <div class="form-group">
                    <label>Display Layer:</label>

                    <!-- Visualization mode toggle -->
                    <div class="visualization-mode-container" style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                        <h4 style="margin: 0 0 8px 0; font-size: 14px; color: #495057;">üó∫Ô∏è Visualization Mode</h4>
                        <div style="display: flex; gap: 10px;">
                            <label style="display: flex; align-items: center; cursor: pointer; font-size: 13px;">
                                <input type="radio" name="vizMode" value="choropleth" checked style="margin-right: 5px;">
                                <span>üìç Geographic Areas</span>
                            </label>
                            <label style="display: flex; align-items: center; cursor: pointer; font-size: 13px;">
                                <input type="radio" name="vizMode" value="bubble" style="margin-right: 5px;">
                                <span>ü´ß Population Bubbles</span>
                            </label>
                        </div>
                        <div style="font-size: 11px; color: #6c757d; margin-top: 5px; font-style: italic;">
                            "Land doesn't vote, people do" - Toggle to see results weighted by population
                        </div>
                    </div>

                    <div style="display: flex; align-items: flex-start; gap: var(--space-2);">
                        <div id="layer-selector" style="flex: 1;">
                            <!-- Custom layer selector will be populated here -->
                        </div>
                        <button type="button"
                                id="layer-help-btn"
                                class="btn help-btn"
                                style="padding: var(--space-2); width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;"
                                title="Click for detailed explanation of this data layer"
                                aria-label="Show layer explanation">
                            ?
                        </button>
                    </div>
                    <div id="layer-explanation"
                         style="display: none; margin-top: var(--space-3); padding: var(--space-3);
                                background: var(--color-bg-secondary); border-radius: var(--border-radius);
                                border-left: 4px solid var(--color-primary); font-size: var(--font-size-xs);">
                    </div>
                </div>

                <!-- Opacity Control -->
                <div class="form-group">
                    <label for="opacity-slider">Layer Opacity:</label>
                    <input type="range"
                           id="opacity-slider"
                           min="0.1"
                           max="1"
                           step="0.1"
                           value="0.7"
                           aria-describedby="opacity-help"
                           aria-valuetext="70 percent">
                    <output for="opacity-slider" id="opacity-value" aria-live="polite">70%</output>
                    <div id="opacity-help" class="sr-only">Adjust the transparency of the map layer</div>
                </div>

                <!-- Range Control -->
                <div class="form-group" id="range-control" style="display: none;">
                    <label>Color Range (adjust for better contrast):</label>
                    <div class="range-inputs">
                        <input type="number"
                               id="range-min"
                               placeholder="Min"
                               step="0.1"
                               aria-label="Minimum value for color range">
                        <input type="number"
                               id="range-max"
                               placeholder="Max"
                               step="0.1"
                               aria-label="Maximum value for color range">
                    </div>
                    <div class="range-display" id="range-display" aria-live="polite"></div>
                    <button type="button"
                            id="reset-range-btn"
                            class="btn btn-block"
                            aria-describedby="reset-help">
                        Reset to Auto
                    </button>
                    <div id="reset-help" class="sr-only">Reset color range to automatic values</div>
                </div>

                <!-- Base Map Selection -->
                <div class="form-group">
                    <label for="basemap-select">Base Map:</label>
                    <select id="basemap-select" aria-describedby="basemap-help">
                        <option value="streets">Streets</option>
                        <option value="satellite">Satellite</option>
                        <option value="topo">Topographic</option>
                        <option value="dark">Dark Mode</option>
                        <option value="dark-nolabels">Dark (No Labels)</option>
                    </select>
                    <div id="basemap-help" class="sr-only">Choose the background map style</div>
                </div>
                    </div>
                </section>

                <!-- Location & Search -->
                <section class="section collapsed" data-section="location-search">
                    <div class="section-header">
                        <h4 id="location-heading">Location & Search</h4>
                        <span class="section-toggle">‚ñº</span>
                    </div>
                    <div class="section-content">
                        <div class="form-group">
                            <label for="address-search">Search Address or Landmark:</label>
                            <div style="display: flex; gap: var(--space-2);">
                                <input type="text"
                                       id="address-search"
                                       placeholder="Enter address, school name, or landmark"
                                       style="flex: 1; padding: var(--space-2); border: 1px solid var(--color-border); border-radius: var(--border-radius);">
                                <button type="button"
                                        id="search-btn"
                                        class="btn"
                                        style="padding: var(--space-2) var(--space-3);">
                                    üîç
                                </button>
                            </div>
                            <div id="search-results" style="margin-top: var(--space-2); display: none;"></div>
                        </div>

                        <button type="button"
                                id="find-location-btn"
                                class="btn btn-block"
                                aria-describedby="location-help">
                            üìç Find My Location
                        </button>
                        <div id="location-help" class="sr-only">Use GPS to find your current location and see which precinct you're in</div>
                    </div>
                </section>

                <!-- Advanced Features -->
                <section class="section collapsed" data-section="advanced-features">
                    <div class="section-header">
                    <h4 id="features-heading">Advanced Features</h4>
                        <span class="section-toggle">‚ñº</span>
                    </div>
                    <div class="section-content">
                    <button type="button"
                            class="btn btn-block"
                            id="heatmap-btn"
                            aria-pressed="false"
                            aria-describedby="heatmap-help">
                        üî• Vote Heatmap
                    </button>
                    <div id="heatmap-help" class="sr-only">Toggle heat map overlay showing vote density</div>

                        <button type="button"
                                class="btn btn-block"
                                id="coordinates-btn"
                                aria-pressed="false"
                                aria-describedby="coords-help">
                            üî¢ Show Coordinates
                        </button>
                        <div id="coords-help" class="sr-only">Toggle coordinate display on click/hover</div>

                        <button type="button"
                                class="btn btn-block"
                                id="comparison-btn"
                                aria-pressed="false"
                                aria-describedby="comparison-help">
                            üé≠ Comparison Mode
                        </button>
                        <div id="comparison-help" class="sr-only">Compare two different data layers side by side</div>

                    <button type="button"
                            id="export-btn"
                            class="btn btn-block"
                            aria-describedby="export-help">
                        üì∏ Export Image
                    </button>
                    <div id="export-help" class="sr-only">Export current map view as PNG image</div>

                        <button type="button"
                                id="share-btn"
                                class="btn btn-block"
                                aria-describedby="share-help">
                            üîó Share Map View
                        </button>
                        <div id="share-help" class="sr-only">Generate shareable link with current map settings</div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: var(--space-2); margin-top: var(--space-2);">
                            <button type="button"
                                    id="share-twitter-btn"
                                    class="btn"
                                    style="font-size: var(--font-size-sm); padding: var(--space-2);"
                                    title="Share on Twitter">
                                üê¶ Twitter
                            </button>
                            <button type="button"
                                    id="share-facebook-btn"
                                    class="btn"
                                    style="font-size: var(--font-size-sm); padding: var(--space-2);"
                                    title="Share on Facebook">
                                üìò Facebook
                            </button>
                            <button type="button"
                                    id="share-linkedin-btn"
                                    class="btn"
                                    style="font-size: var(--font-size-sm); padding: var(--space-2);"
                                    title="Share on LinkedIn">
                                üíº LinkedIn
                            </button>
                        </div>
                    </div>
                </section>

                <!-- School Overlays -->
                <section class="section collapsed" data-section="school-overlays">
                    <div class="section-header">
                    <h4 id="overlays-heading">School Overlays</h4>
                        <span class="section-toggle">‚ñº</span>
                    </div>
                    <div class="section-content">
                    <fieldset>
                        <legend class="sr-only">School Location Overlays</legend>
                        <div class="overlay-item">
                            <input type="checkbox" id="show-high-schools" aria-describedby="high-schools-help" />
                            <label for="show-high-schools">
                                <svg class="school-icon" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <rect x="2" y="2" width="12" height="12" fill="#4E3A6D" stroke="#000" stroke-width="0.5" rx="1"/>
                                    <rect x="4" y="4" width="8" height="8" fill="#FFFFFF" stroke="#4E3A6D" stroke-width="0.5"/>
                                    <circle cx="8" cy="8" r="2" fill="#4E3A6D"/>
                                </svg>
                                High Schools
                            </label>
                            <div id="high-schools-help" class="sr-only">Show high school locations on map</div>
                        </div>
                        <div class="overlay-item">
                            <input type="checkbox" id="show-middle-schools" aria-describedby="middle-schools-help" />
                            <label for="show-middle-schools">
                                <svg class="school-icon" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <polygon points="8,2 14,14 2,14" fill="#4F4F4F" stroke="#000" stroke-width="0.5"/>
                                    <polygon points="8,4 12,12 4,12" fill="#FFFFFF" stroke="#4F4F4F" stroke-width="0.5"/>
                                    <circle cx="8" cy="10" r="1.5" fill="#4F4F4F"/>
                                </svg>
                                Middle Schools
                            </label>
                            <div id="middle-schools-help" class="sr-only">Show middle school locations on map</div>
                        </div>
                        <div class="overlay-item">
                            <input type="checkbox" id="show-elementary-schools" aria-describedby="elementary-schools-help" />
                            <label for="show-elementary-schools">
                                <svg class="school-icon" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <circle cx="8" cy="8" r="6" fill="#000000" stroke="#4F4F4F" stroke-width="0.5"/>
                                    <circle cx="8" cy="8" r="4" fill="#F4F4F3" stroke="#000000" stroke-width="0.5"/>
                                    <circle cx="8" cy="8" r="2" fill="#000000"/>
                                </svg>
                                Elementary Schools
                            </label>
                            <div id="elementary-schools-help" class="sr-only">Show elementary school locations on map</div>
                        </div>
                    </fieldset>

                    <fieldset>
                        <legend class="sr-only">School Boundary Overlays</legend>
                        <div class="overlay-item">
                            <input type="checkbox" id="show-high-boundaries" aria-describedby="high-boundaries-help" />
                            <label for="show-high-boundaries">High School Boundaries</label>
                            <div id="high-boundaries-help" class="sr-only">Show high school attendance boundaries</div>
                        </div>
                        <div class="overlay-item">
                            <input type="checkbox" id="show-middle-boundaries" aria-describedby="middle-boundaries-help" />
                            <label for="show-middle-boundaries">Middle School Boundaries</label>
                            <div id="middle-boundaries-help" class="sr-only">Show middle school attendance boundaries</div>
                        </div>
                        <div class="overlay-item">
                            <input type="checkbox" id="show-elementary-boundaries" aria-describedby="elementary-boundaries-help" />
                            <label for="show-elementary-boundaries">Elementary Boundaries</label>
                            <div id="elementary-boundaries-help" class="sr-only">Show elementary school attendance boundaries</div>
                        </div>
                        <div class="overlay-item">
                            <input type="checkbox" id="show-district-boundary" aria-describedby="district-boundary-help" />
                            <label for="show-district-boundary">District Boundary</label>
                            <div id="district-boundary-help" class="sr-only">Show school district boundary</div>
                        </div>
                    </fieldset>
                    </div>
                </section>
            </form>
        </aside>

        <!-- Information Panel -->
        <aside class="info-panel panel" role="complementary" aria-labelledby="info-heading" aria-live="polite">
            <header>
                <h3 id="info-heading">2025 School Board Zone 1</h3>
            </header>

            <!-- Summary Statistics -->
            <section class="stats-summary" id="stats-summary" aria-labelledby="stats-heading">
                <h4 id="stats-heading" class="sr-only">Election Summary Statistics</h4>
                <!-- Content populated by JavaScript -->
            </section>

            <!-- Precinct Information -->
            <section id="precinct-info" aria-labelledby="precinct-heading">
                <h4 id="precinct-heading" class="sr-only">Precinct Information</h4>
                <p><strong>Click a precinct</strong> to see detailed results.</p>
                <p>Hover over precincts to see basic information, or click for detailed candidate results.</p>
            </section>
        </aside>
    </main>

    <!-- Color Scale Legend -->
    <div id="color-scale-legend" role="img" aria-labelledby="legend-title">
        <div class="legend-title" id="legend-title">Loading...</div>
        <div class="legend-bar" id="legend-bar"></div>
        <div class="legend-labels">
            <span class="legend-min" id="legend-min">0</span>
            <span class="legend-max" id="legend-max">100</span>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

    <!-- Leaflet plugins -->
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script src="https://unpkg.com/leaflet-fullscreen@1.0.1/dist/Leaflet.fullscreen.min.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

    <!-- Image export -->
    <script src="https://cdn.jsdelivr.net/npm/dom-to-image@2.6.0/dist/dom-to-image.min.js"></script>

    <!-- New Modular Application Architecture -->
    <script type="module">
        // Import and start the new modular application
        import { bootstrap } from './js/app.js';

        // The bootstrap function handles all initialization
        // and replaces the old monolithic JavaScript code
        console.log('üó≥Ô∏è Portland School Board Election Map - Modular Architecture');
        console.log('üìä Starting application with componentized architecture...');

        // Global error handling for any initialization issues
        window.addEventListener('error', function(e) {
            if (e.message && e.message.includes('touchleave')) {
                console.warn('Ignoring touchleave error (known Leaflet issue):', e.message);
                e.preventDefault();
                return true;
            }
        });
    </script>
</body>
</html>
