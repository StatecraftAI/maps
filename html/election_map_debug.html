<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Election Map Debug - Data Inspection</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Leaflet Vector Tiles Plugin -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.vectorgrid@1.3.0/dist/Leaflet.VectorGrid.css" />
    
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f8f9fa;
        }
        
        #map {
            height: 100vh;
            width: 100%;
        }
        
        .debug-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 15px;
            min-width: 300px;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .debug-panel h3 {
            margin: 0 0 10px 0;
            font-size: 16px;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #007cba;
            padding-bottom: 5px;
        }
        
        .control-group {
            margin-bottom: 15px;
        }
        
        .control-group h4 {
            margin: 0 0 8px 0;
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }
        
        .control-group select,
        .control-group input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }
        
        .properties-list {
            max-height: 200px;
            overflow-y: auto;
            background: #f8f9fa;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
        }
        
        .property-item {
            margin-bottom: 5px;
            padding: 2px 0;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .property-key {
            font-weight: 600;
            color: #007cba;
        }
        
        .property-value {
            color: #666;
            margin-left: 10px;
        }
        
        .color-test {
            width: 20px;
            height: 20px;
            border: 1px solid #333;
            display: inline-block;
            margin-right: 10px;
        }
        
        .status {
            background: #f0f8ff;
            border-radius: 4px;
            padding: 8px;
            margin-bottom: 10px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <!-- Debug Panel -->
    <div class="debug-panel">
        <h3>Debug Panel</h3>
        
        <div class="status" id="status">
            Loading vector tiles...
        </div>
        
        <div class="control-group">
            <h4>Test Layer</h4>
            <select id="layerSelect">
                <option value="political_lean">Political Lean</option>
                <option value="competitiveness">Competitiveness</option>
                <option value="leading_candidate">Leading Candidate</option>
                <option value="turnout_rate">Turnout Rate</option>
                <option value="cnt_total_votes">Total Votes</option>
                <option value="precinct">Precinct</option>
                <option value="solid_color">Solid Red (Test)</option>
            </select>
        </div>
        
        <div class="control-group">
            <h4>Opacity</h4>
            <input type="range" id="opacitySlider" min="0.1" max="1" step="0.1" value="0.8">
            <span id="opacityValue">0.8</span>
        </div>
        
        <div class="control-group">
            <h4>Current Color Test</h4>
            <div id="colorTest">
                <div class="color-test" id="testColor" style="background-color: #ff0000;"></div>
                <span id="colorValue">#ff0000</span>
            </div>
        </div>
        
        <div class="control-group">
            <h4>Click a Precinct</h4>
            <div class="properties-list" id="propertiesList">
                Click on any precinct to see all available properties...
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Leaflet Vector Tiles Plugin -->
    <script src="https://unpkg.com/leaflet.vectorgrid@1.3.0/dist/Leaflet.VectorGrid.bundled.js"></script>

    <script>
        // Global variables
        let map;
        let vectorTileLayer;
        let currentLayer = 'political_lean';
        let tileServerUrl = 'http://localhost:8080/data/2025_election_zone1_total_votes_tiles/{z}/{x}/{y}.pbf';
        let sampleProperties = null;
        
        // Initialize map
        function initMap() {
            // Create map centered on Portland area
            map = L.map('map', {
                center: [45.515, -122.68],
                zoom: 11,
                zoomControl: true
            });
            
            // Add simple base map
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors',
                maxZoom: 18
            }).addTo(map);
            
            // Load vector tiles
            loadVectorTiles();
            
            // Set up event listeners
            setupEventListeners();
            
            updateStatus('Map initialized, loading vector tiles...');
            console.log('Map initialized');
        }
        
        function loadVectorTiles() {
            console.log('Loading vector tiles from:', tileServerUrl);
            
            vectorTileLayer = L.vectorGrid.protobuf(tileServerUrl, {
                rendererFactory: L.canvas.tile,
                vectorTileLayerStyles: {
                    'election_results': getDebugStyle
                },
                interactive: true,
                getFeatureId: function(f) {
                    return f.properties.precinct || f.properties.Precinct || Math.random();
                }
            });
            
            vectorTileLayer.addTo(map);
            
            // Set up click events
            vectorTileLayer.on('click', function(e) {
                showProperties(e.layer.properties);
                sampleProperties = e.layer.properties;
                updateStatus('Clicked on precinct - see properties below');
            });
            
            // Update when tiles load
            vectorTileLayer.on('load', function() {
                updateStatus('Vector tiles loaded successfully!');
            });
            
            vectorTileLayer.on('error', function(e) {
                updateStatus('Error loading vector tiles: ' + e.message);
            });
            
            console.log('Vector tiles layer created');
        }
        
        function getDebugStyle(properties, zoom) {
            const opacity = parseFloat(document.getElementById('opacitySlider').value);
            let fillColor = getDebugColor(properties, currentLayer);
            
            // Always show something - even if transparent, show a stroke
            return {
                fillColor: fillColor,
                fillOpacity: opacity,
                color: '#000000',  // Black stroke
                weight: 2,         // Thick stroke so we can see it
                opacity: 1         // Always visible stroke
            };
        }
        
        function getDebugColor(properties, layer) {
            console.log('Getting color for layer:', layer, 'Properties:', properties);
            
            if (layer === 'solid_color') {
                return '#ff0000'; // Bright red for testing
            }
            
            const value = properties[layer];
            console.log('Value for', layer, ':', value, typeof value);
            
            // Show what we got
            updateColorTest(value);
            
            if (!value) {
                console.log('No value found for', layer);
                return '#999999'; // Gray for missing data
            }
            
            // Try to determine what kind of data this is
            if (typeof value === 'string') {
                // Hash the string to get a consistent color
                let hash = 0;
                for (let i = 0; i < value.length; i++) {
                    const char = value.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash; // Convert to 32-bit integer
                }
                
                const colors = ['#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c', '#e67e22'];
                return colors[Math.abs(hash) % colors.length];
            } else if (typeof value === 'number') {
                // Use a simple color ramp for numbers
                const normalized = Math.min(Math.max(value, 0), 1);
                const red = Math.floor(255 * (1 - normalized));
                const green = Math.floor(255 * normalized);
                return `rgb(${red}, ${green}, 100)`;
            } else if (typeof value === 'boolean') {
                return value ? '#2ecc71' : '#e74c3c'; // Green for true, red for false
            }
            
            // Default bright color so we know something is there
            return '#ff00ff'; // Bright magenta
        }
        
        function showProperties(properties) {
            const propertiesList = document.getElementById('propertiesList');
            let html = '';
            
            const sortedKeys = Object.keys(properties).sort();
            
            sortedKeys.forEach(key => {
                const value = properties[key];
                html += `<div class="property-item">`;
                html += `<span class="property-key">${key}:</span>`;
                html += `<span class="property-value">${value} (${typeof value})</span>`;
                html += `</div>`;
            });
            
            if (html === '') {
                html = '<div class="property-item">No properties found</div>';
            }
            
            propertiesList.innerHTML = html;
            
            console.log('All properties:', properties);
        }
        
        function updateColorTest(value) {
            const colorTest = document.getElementById('testColor');
            const colorValue = document.getElementById('colorValue');
            const color = getDebugColor(sampleProperties || {}, currentLayer);
            
            colorTest.style.backgroundColor = color;
            colorValue.textContent = `${color} (value: ${value})`;
        }
        
        function updateStatus(message) {
            document.getElementById('status').textContent = message;
            console.log('Status:', message);
        }
        
        function setupEventListeners() {
            document.getElementById('layerSelect').addEventListener('change', function(e) {
                currentLayer = e.target.value;
                updateStatus(`Switched to layer: ${currentLayer}`);
                if (vectorTileLayer) {
                    vectorTileLayer.redraw();
                }
                if (sampleProperties) {
                    updateColorTest(sampleProperties[currentLayer]);
                }
            });
            
            document.getElementById('opacitySlider').addEventListener('input', function(e) {
                const opacity = e.target.value;
                document.getElementById('opacityValue').textContent = opacity;
                if (vectorTileLayer) {
                    vectorTileLayer.redraw();
                }
            });
        }
        
        // Check if tile server is running
        function checkTileServer() {
            fetch('http://localhost:8080/')
                .then(response => {
                    if (response.ok) {
                        console.log('Tile server is running');
                        updateStatus('Tile server detected, initializing map...');
                        initMap();
                    } else {
                        showTileServerError();
                    }
                })
                .catch(error => {
                    console.error('Tile server not accessible:', error);
                    showTileServerError();
                });
        }
        
        function showTileServerError() {
            updateStatus('Tile server not running!');
            document.body.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; height: 100vh; flex-direction: column; font-family: sans-serif;">
                    <h2 style="color: #e74c3c;">Tile Server Not Running</h2>
                    <p>Please start the tile server by running:</p>
                    <code style="background: #f8f9fa; padding: 10px; border-radius: 4px; margin: 10px;">
                        ./ops/serve_tiles.sh
                    </code>
                    <p>Then refresh this page.</p>
                </div>
            `;
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            checkTileServer();
        });
    </script>
</body>
</html> 