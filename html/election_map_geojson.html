<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2025 Portland School Board Zone 1 Election Map</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Chart.js for popup charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
        }
        
        #map {
            height: 100vh;
            width: 100%;
        }
        
        .info-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            max-width: 300px;
            font-size: 14px;
        }
        
        .control-panel {
            position: absolute;
            top: 10px;
            left: 10px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            max-width: 250px;
        }
        
        .layer-control {
            margin-bottom: 10px;
        }
        
        .layer-control label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        
        .layer-control select {
            width: 100%;
            padding: 5px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        
        .opacity-control {
            margin: 10px 0;
        }
        
        .opacity-control input {
            width: 100%;
        }
        
        .legend {
            margin-top: 10px;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 8px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        
        .popup-chart {
            width: 300px;
            height: 200px;
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2000;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .zone-filter {
            margin-bottom: 15px;
        }
        
        .zone-filter input {
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <div id="loading" class="loading">
        <h3>Loading Election Data...</h3>
        <p>Please wait while we load the precinct data.</p>
    </div>
    
    <div id="map"></div>
    
    <div class="control-panel">
        <h3>Map Controls</h3>
        
        <div class="zone-filter">
            <label>
                <input type="checkbox" id="zone1-only" checked> Show Zone 1 Only
            </label>
        </div>
        
        <div class="layer-control">
            <label for="layer-select">Display Layer:</label>
            <select id="layer-select">
                <option value="political_lean">Political Lean</option>
                <option value="competitiveness">Competitiveness</option>
                <option value="leading_candidate">Leading Candidate</option>
                <option value="turnout_rate">Turnout Rate</option>
                <option value="vote_margin">Victory Margin</option>
                <option value="cnt_total_votes">Total Votes</option>
                <option value="dem_advantage">Democratic Advantage</option>
                <option value="pct_cavagnolo">Cavagnolo %</option>
                <option value="pct_splitt">Splitt %</option>
            </select>
        </div>
        
        <div class="opacity-control">
            <label for="opacity-slider">Layer Opacity:</label>
            <input type="range" id="opacity-slider" min="0.1" max="1" step="0.1" value="0.7">
            <span id="opacity-value">70%</span>
        </div>
        
        <div class="layer-control">
            <label for="basemap-select">Base Map:</label>
            <select id="basemap-select">
                <option value="streets">Streets</option>
                <option value="satellite">Satellite</option>
                <option value="topo">Topographic</option>
            </select>
        </div>
        
        <div id="legend" class="legend"></div>
    </div>
    
    <div class="info-panel">
        <h3>2025 School Board Zone 1</h3>
        <p><strong>Click a precinct</strong> to see detailed results.</p>
        <div id="precinct-info">
            <p>Hover over precincts to see basic information, or click for detailed candidate results.</p>
        </div>
    </div>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // Initialize the map
        const map = L.map('map').setView([45.5152, -122.6784], 11);
        
        // Base map layers
        const baseMaps = {
            streets: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }),
            satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: '© Esri'
            }),
            topo: L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenTopoMap contributors'
            })
        };
        
        // Default base map
        baseMaps.streets.addTo(map);
        
        // Global variables
        let electionData = null;
        let currentLayer = null;
        let currentField = 'political_lean';
        let showZone1Only = true;
        
        // Color schemes for different data types
        const colorSchemes = {
            political_lean: {
                'Strong Dem': '#1f77b4',
                'Lean Dem': '#aec7e8', 
                'Competitive': '#ffbb78',
                'Lean Rep': '#ff7f0e',
                'Strong Rep': '#d62728'
            },
            competitiveness: {
                'Safe': '#2ca02c',
                'Likely': '#98df8a',
                'Competitive': '#ff7f0e',
                'Tossup': '#d62728'
            },
            leading_candidate: {
                'Cavagnolo': '#1f77b4',
                'Splitt': '#ff7f0e', 
                'Leof': '#2ca02c',
                'Tie': '#7f7f7f'
            }
        };
        
        // Load and display the GeoJSON data
        async function loadElectionData() {
            try {
                const response = await fetch('../data/geospatial/2025_election_zone1_total_votes_processed.geojson');
                electionData = await response.json();
                
                console.log('Loaded GeoJSON with', electionData.features.length, 'features');
                console.log('Sample properties:', electionData.features[0].properties);
                
                updateMap();
                document.getElementById('loading').style.display = 'none';
                
            } catch (error) {
                console.error('Error loading election data:', error);
                document.getElementById('loading').innerHTML = '<h3>Error Loading Data</h3><p>Could not load election data. Please check the console for details.</p>';
            }
        }
        
        // Get color for a feature based on current field
        function getFeatureColor(properties) {
            const value = properties[currentField];
            
            if (colorSchemes[currentField]) {
                return colorSchemes[currentField][value] || '#808080';
            }
            
            // For numeric fields, use a gradient
            if (typeof value === 'number') {
                if (currentField.includes('pct_') || currentField === 'turnout_rate') {
                    // Percentage values (0-100)
                    const intensity = Math.min(value / 100, 1);
                    return `hsl(${240 - intensity * 120}, 70%, ${70 - intensity * 20}%)`;
                } else if (currentField === 'cnt_total_votes') {
                    // Vote counts - use log scale
                    const maxVotes = 2000; // approximate max
                    const intensity = Math.min(Math.log(value + 1) / Math.log(maxVotes), 1);
                    return `hsl(${240 - intensity * 120}, 70%, ${70 - intensity * 20}%)`;
                } else {
                    // Other numeric values
                    const intensity = Math.min(Math.abs(value) / 50, 1);
                    return `hsl(${value >= 0 ? 240 : 0}, 70%, ${70 - intensity * 20}%)`;
                }
            }
            
            return '#808080'; // Default gray
        }
        
        // Style function for GeoJSON layer
        function styleFeature(feature) {
            const props = feature.properties;
            
            // Filter for Zone 1 if enabled
            if (showZone1Only && !props.in_zone1) {
                return {
                    fillColor: 'transparent',
                    color: 'transparent',
                    weight: 0,
                    fillOpacity: 0
                };
            }
            
            return {
                fillColor: getFeatureColor(props),
                weight: 1,
                opacity: 0.8,
                color: '#666',
                fillOpacity: parseFloat(document.getElementById('opacity-slider').value)
            };
        }
        
        // Create popup content with candidate results chart
        function createPopupContent(properties) {
            const candidates = [
                { name: 'Cavagnolo', count: properties.cnt_cavagnolo, pct: properties.pct_cavagnolo },
                { name: 'Splitt', count: properties.cnt_splitt, pct: properties.pct_splitt },
                { name: 'Leof', count: properties.cnt_leof, pct: properties.pct_leof }
            ].filter(c => c.count > 0);
            
            const popupId = 'popup-' + Math.random().toString(36).substr(2, 9);
            
            let content = `
                <div style="width: 350px;">
                    <h3>Precinct ${properties.precinct}</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div>
                            <strong>Election Results:</strong><br>
                            <small>Total Votes: ${properties.cnt_total_votes || 'N/A'}</small><br>
                            <small>Turnout: ${properties.turnout_rate ? properties.turnout_rate.toFixed(1) + '%' : 'N/A'}</small><br>
                            <small>Leading: ${properties.leading_candidate || 'N/A'}</small>
                        </div>
                        <div>
                            <strong>Analysis:</strong><br>
                            <small>Political Lean: ${properties.political_lean || 'N/A'}</small><br>
                            <small>Competitiveness: ${properties.competitiveness || 'N/A'}</small><br>
                            <small>Margin: ${properties.vote_margin ? properties.vote_margin.toFixed(1) + '%' : 'N/A'}</small>
                        </div>
                    </div>
            `;
            
            if (candidates.length > 0) {
                content += `
                    <div>
                        <strong>Candidate Results:</strong>
                        <canvas id="${popupId}" class="popup-chart"></canvas>
                    </div>
                `;
            }
            
            content += '</div>';
            
            // Set up chart after popup opens
            setTimeout(() => {
                const canvas = document.getElementById(popupId);
                if (canvas && candidates.length > 0) {
                    new Chart(canvas, {
                        type: 'bar',
                        data: {
                            labels: candidates.map(c => c.name),
                            datasets: [{
                                label: 'Votes',
                                data: candidates.map(c => c.count),
                                backgroundColor: ['#1f77b4', '#ff7f0e', '#2ca02c'],
                                borderColor: ['#1f77b4', '#ff7f0e', '#2ca02c'],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: { display: true, text: 'Votes' }
                                }
                            }
                        }
                    });
                }
            }, 100);
            
            return content;
        }
        
        // Update the map with current settings
        function updateMap() {
            if (!electionData) return;
            
            // Remove existing layer
            if (currentLayer) {
                map.removeLayer(currentLayer);
            }
            
            // Create new layer
            currentLayer = L.geoJSON(electionData, {
                style: styleFeature,
                onEachFeature: function(feature, layer) {
                    const props = feature.properties;
                    
                    // Skip if filtering Zone 1 and not in zone
                    if (showZone1Only && !props.in_zone1) return;
                    
                    // Hover effects
                    layer.on('mouseover', function() {
                        const info = document.getElementById('precinct-info');
                        info.innerHTML = `
                            <strong>Precinct ${props.precinct}</strong><br>
                            ${currentField.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}: 
                            ${typeof props[currentField] === 'number' ? 
                                (currentField.includes('pct_') || currentField === 'turnout_rate' ? 
                                    props[currentField].toFixed(1) + '%' : 
                                    props[currentField].toLocaleString()) :
                                props[currentField] || 'N/A'}
                        `;
                        
                        layer.setStyle({
                            weight: 3,
                            color: '#fff',
                            fillOpacity: 0.9
                        });
                    });
                    
                    layer.on('mouseout', function() {
                        currentLayer.resetStyle(layer);
                    });
                    
                    // Click for detailed popup
                    layer.on('click', function() {
                        layer.bindPopup(createPopupContent(props), {
                            maxWidth: 400,
                            className: 'election-popup'
                        }).openPopup();
                    });
                }
            }).addTo(map);
            
            updateLegend();
        }
        
        // Update the legend
        function updateLegend() {
            const legend = document.getElementById('legend');
            legend.innerHTML = '<h4>' + currentField.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) + '</h4>';
            
            if (colorSchemes[currentField]) {
                Object.entries(colorSchemes[currentField]).forEach(([value, color]) => {
                    legend.innerHTML += `
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: ${color}"></div>
                            <span>${value}</span>
                        </div>
                    `;
                });
            } else {
                legend.innerHTML += '<p>Darker colors indicate higher values</p>';
            }
        }
        
        // Event listeners
        document.getElementById('layer-select').addEventListener('change', function() {
            currentField = this.value;
            updateMap();
        });
        
        document.getElementById('opacity-slider').addEventListener('input', function() {
            const value = Math.round(this.value * 100);
            document.getElementById('opacity-value').textContent = value + '%';
            updateMap();
        });
        
        document.getElementById('zone1-only').addEventListener('change', function() {
            showZone1Only = this.checked;
            updateMap();
        });
        
        document.getElementById('basemap-select').addEventListener('change', function() {
            // Remove all base maps
            Object.values(baseMaps).forEach(layer => map.removeLayer(layer));
            // Add selected base map
            baseMaps[this.value].addTo(map);
        });
        
        // Load data when page loads
        loadElectionData();
        
    </script>
</body>
</html> 